## Postgresql 分区表实现
                                                                   
### 作者                                                                   
dinglq                                                                   
                                                                   
### 日期                                                                   
2018-09-22                                                                 
                                                                   
### 标签                                                                   
PostgreSQL , 分区表     
                                                                   
----                                                                   
                                                                   
## 1. 传统方式实现
建立用户访问日志表，按照登录时间，每个月一个分区表。
### 1.1 创建父表
```
create table user_login_history(
	uid int,
	uname varchar(30),
	login_time timestamp
);
```
### 1.2 创建子表
每个月一个分区建立继承表
```
create table user_login_history_201808(like user_login_history including all) inherits(user_login_history);
create table user_login_history_201809(like user_login_history including all) inherits(user_login_history);
```
### 1.3 实现分区功能
要想实现分区功能，需要满足两个条件：
1. 往user_login_history表中插入数据，数据会根据分区键自动的插入到数据属于的子表中。
2. 查询user_login_history表时，命中数据在哪些分区，只需查询哪些分区。

要满足这两个条件，需要使用触发器（或者规则）和约束来实现。
#### 1.3.1 添加约束
```
ALTER TABLE user_login_history_201808 ADD CONSTRAINT user_login_history_201808_logtime
	CHECK(login_time >=DATE '2018-08-01' and login_time < DATE '2018-09-01');
	
ALTER TABLE user_login_history_201809 ADD CONSTRAINT user_login_history_201809_logtime
	CHECK(login_time >=DATE '2018-09-01' and login_time < DATE '2018-10-01');	
```
或者是创建子表时，指定check约束
```
CREATE TABLE user_login_history_201810(
	LIKE user_login_history INCLUDING ALL,
	CHECK ( login_time >= DATE '2018-10-01' AND login_time < DATE '2018-11-01' )
)INHERITS(user_login_history);
```

#### 1.3.2 添加规则
首先，在主表上建立规则，将插入数据放到相应的子表中去。
```
CREATE OR REPLACE RULE user_log_history_insert_201808 AS 
ON INSERT TO user_login_history WHERE login_time >=DATE '2018-08-01' and login_time < DATE '2018-09-01'
DO INSTEAD 
   INSERT INTO user_login_history_201808 VALUES(NEW.*);

CREATE OR REPLACE RULE user_log_history_insert_201809 AS
ON INSERT TO user_login_history WHERE login_time >=DATE '2018-09-01' and login_time < DATE '2018-10-01'
DO INSTEAD 
   INSERT INTO user_login_history_201809 VALUES(NEW.*);
```


#### 1.3.4 验证
插入数据
```
INSERT INTO user_login_history(uid,uname,login_time)
values
(1,'黄飞鸿',to_timestamp('2018-08-23 16:23:21','yyyy-mm-dd hh24:mi:ss')),
(2,'霍元甲',to_timestamp('2018-09-3 19:23:21','yyyy-mm-dd hh24:mi:ss'))
```
查询数据
```
test=# select * from user_login_history;
 uid | uname  |     login_time      
-----+--------+---------------------
   1 | 黄飞鸿 | 2018-08-23 16:23:21
   2 | 霍元甲 | 2018-09-03 19:23:21
(2 rows)

test=# select * from user_login_history_201808 ;
 uid | uname  |     login_time      
-----+--------+---------------------
   1 | 黄飞鸿 | 2018-08-23 16:23:21
(1 row)

test=# select * from user_login_history_201809 ;
 uid | uname  |     login_time      
-----+--------+---------------------
   2 | 霍元甲 | 2018-09-03 19:23:21
(1 row)
```

















